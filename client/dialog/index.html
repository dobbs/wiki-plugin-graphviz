<!DOCTYPE html>
<html>
  <head>
    <title>Graphviz</title>
    <link id="favicon" href="/favicon.png" rel="icon" type="image/png" />
    <link href="/plugins/graphviz/dialog/style.css" rel="stylesheet" />
    <script>
      var graph;

      let zoomLvl = 1
      let xOffset = 0
      let yOffset = 0

      function click(event) {
        event.stopPropagation()
        event.preventDefault()

        const keepLineup = event.shiftKey
        document.getSelection().removeAllRanges()

        const node = event.target.closest('.node')
        const edge = event.target.closest('.edge')
        if (node||edge) {
          const title = Array.from(
            (node||edge).querySelectorAll("text")
          ).map(el => el.textContent.trim()).join(" ")
          //let $page = event.shiftKey ? null : $item.parents('.page')
          if (title) {
            console.log('click', title)
            window.opener.postMessage({ action: 'doInternalLink', keepLineup, pageKey: window.pageKey, title })
            // set context for doInternalLink
            //wiki.pageHandler.context = wiki.lineup.atKey($page.data('key')).getContext()
            //wiki.doInternalLink(title, $page)
          }
        }
      }

      function pan(event) {
        event.preventDefault()
        const dx = event.movementX
        const dy = event.movementY

        xOffset += dx;
        yOffset += dy;

        graph.setAttribute('transform', `translate(${xOffset}, ${yOffset}) scale(${zoomLvl})`);
      }

      function zoom(event) {
        event.preventDefault()
        const deltaY = event.deltaY || event.wheelDeltaY; // Check for different properties for compatibility
        // is this the right way around?
        if (deltaY < 0) {
          zoomLvl *= 1.01;
        } else {
          zoomLvl *= 0.99;
        }

        graph.setAttribute('transform', `translate(${xOffset}, ${yOffset}) scale(${zoomLvl})`);
      }

      function pointerLeaves(event) {
        event.preventDefault()
        console.log('pointer has left the room')
        // this will turn off the pan as soon as the pointer leaves the svg
        // do we need to track when it comes back, in case the pointer is still pressed?
        graph.removeEventListener('pointermove', pan)
        graph.removeEventListener('pointerleave', pointerLeaves)
        graph.removeEventListener('pointerup', pointerUp)
        // Maybe not, needs work!
        //svg.addEventListener('pointerover', pointerEnters)
      }

      function pointerEnters(event) {
        // currently not used, it just gets strange.
        console.log('we are back!')
        event.preventDefault()
        graph.addEventListener('pointermove', pan);
        graph.addEventListener('pointerleave', pointerLeaves)
      }

      function pointerUp(event) {
        event.preventDefault()
        graph.removeEventListener('pointermove', pan);
        graph.removeEventListener('pointerleave', pointerLeaves)
        graph.removeEventListener('pointerup', pointerUp)
      }

      window.addEventListener(
        "message",
        (event) => {
          const { svg, pageKey } = event.data
          console.log('data', event.data)
          window.pageKey = pageKey
          //document.title = data.title
          document.querySelector('.page').innerHTML = svg

          graph = document.querySelector('svg');
          // reset state.
          zoomLvl = 1
          xOffset = 0
          yOffset = 0
          
          graph.addEventListener('click', click)

          graph.addEventListener('pointerdown', (event) => {
            event.preventDefault(); // Prevent default drag behavior
            graph.addEventListener('pointermove', pan);
            graph.addEventListener('pointerleave', pointerLeaves);
            graph.addEventListener('pointerup', pointerUp);
          })

          graph.addEventListener('wheel', zoom);

        }
      )



    </script>
  </head>
  <body>
    <div class="page">
    </div>
  </body>
</html>